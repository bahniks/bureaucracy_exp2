<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
    <script>
      window.requestAnimFrame = (function(callback) {
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
        function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();

      function init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        hSize = window.innerWidth / 9;
        vSize = window.innerHeight / 5;
        font = Math.round(vSize/5).toString() + "px Helvetica";
        linearSpeed = speed * hSize;
      }

      function drawSquare(square, context) {
        context.beginPath();
        context.rect(square.x, square.y - square.size, square.size, square.size);
        context.fillStyle = square.color;
        context.fill();
      }

      function drawTriangle(triangle, context) {
        context.beginPath();
        context.moveTo(triangle.x, triangle.y);
        context.lineTo(triangle.x + triangle.size, triangle.y);
        context.lineTo(triangle.x + triangle.size/2, triangle.y - triangle.size);
        context.closePath();
        context.fillStyle = triangle.color;
        context.fill();
      }

      function drawCircle(circle, context) {
        context.beginPath();
        context.arc(circle.x+circle.size/2, circle.y-circle.size/2, circle.size/2, 0, 2 * Math.PI);
        context.closePath();
        context.fillStyle = circle.color;
        context.fill();
      }

      function animate(lastTime) {
        var time = (new Date()).getTime();
        var timeDiff = time - lastTime;

        // pixels / second
        var linearDistEachFrame = linearSpeed * timeDiff / 1000;
        var newX = currentObject.x + linearDistEachFrame;
        currentObject.x = newX;
        
        if(newX > canvas.width + vSize / 2) {
          newTrial();
        }

        // clear
        context.clearRect(0, 0, canvas.width, canvas.height);

        // draw
        currentObject.fun(currentObject, context);
        if(currentObject.bribe != 0) {
          createBribe(currentObject.bribe, newX, currentObject.y);
        }
        createPots();
        createInfo();

        // request new frame
        requestAnimFrame(function() {
          animate(time);
        });
      }

      function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
      }

      function sample(a) {
        return a[Math.floor(Math.random() * a.length)];
      }

      const shapes = ["triangle", "circle", "square"];
      const colors = ["yellow", "orange", "skyblue"];
      const shapeFunctions = {
        triangle: drawTriangle,
        circle: drawCircle,
        square: drawSquare,
      };

      var potShapes = shuffle(shapes);
      var potColors = shuffle(colors);

      function createPots() {
        for (i = 0; i < 3; i++) {
          fun = shapeFunctions[potShapes[i]];
          var x = (i+1)*window.innerWidth/4 - vSize/2;
          fun({
            x: x,
            y: window.innerHeight - 100,
            size: vSize,
            color: potColors[i],
          }, context);
          context.font = font;
          context.fillStyle = "black";
          context.textAlign = "center";
          context.fillText(i + 1, x + vSize/2, window.innerHeight - 50);
        }
      }

      function changePotsColors() {
        potColors = shuffle(colors);
        createPots();
      }

      function createObject() {
        var shape = sample(shapes);
        var color = sample(colors);
        if(Math.random() < bribeProbability) {
          var bribe = sample(bribeSizes);
        } else {
          var bribe = 0;
        }
        var object = {
            x: -2*vSize,
            y: window.innerHeight/2,
            color: color,
            shape: shape,
            size: vSize,
            fun: shapeFunctions[shape],
            bribe: bribe,
        };
        return object;
      }

      function createBribe(bribe, x, y) {
        context.font = font;
        context.fillStyle = "black";
        context.textAlign = "center";
        context.textBaseline = "middle";
        context.fillText(bribe, x + vSize/2, y - vSize/2);
      }

      function createInfo() {
        context.font = font;
        context.fillStyle = "black";
        context.textAlign = "center";
        context.textBaseline = "middle";
        context.fillText(trial.toString() + "/" + totalTrials.toString(), window.innerWidth/2, vSize/5);
        context.textAlign = "right";
        context.fillText("Charitě: " + charity.toString(), window.innerWidth - hSize/10, vSize/5);
        context.fillText("Odměna: " + reward.toString(), window.innerWidth - hSize/10, window.innerHeight/2 + vSize/2);
      }

      document.addEventListener('keydown', function(event) {
        if(["1", "2", "3"].includes(event.key)) {
          // shape correct
          if(currentObject.shape == potShapes[parseInt(event.key)-1]) {
            reward += currentObject.bribe;
          }          
          // color NOT correct
          if(currentObject.color != potColors[parseInt(event.key)-1]) {
            charity -= charityLoss;
          }      
          reward += 3;
          newTrial();
        };
      });

      function newTrial() {
        trial++;
        changePotsColors();
        currentObject = createObject(); 
      }

      // settings
      const totalTrials = 200;
      const initialCharity = 2000;
      const bribeProbability = 0.2;
      const bribeSizes = [40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190];
      const charityLoss = 200;
      const speed = 3;

      // current state
      var reward = 0;
      var trial = 1;
      var charity = initialCharity;

      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');      
      init();
      createPots();
      var currentObject = createObject();           
      var date = new Date();
      animate(date.getTime());


      window.addEventListener("resize", function () {
        init();
        if(window.innerWidth < 800 | window.innerHeight < 500) {
          alert("Window is too small!"); // stop the task
        }
        currentObject.y = window.innerHeight/2;
        currentObject.size = vSize;
      });

    </script>
  </body>
</html>      